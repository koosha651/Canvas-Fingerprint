import{DISABLED_HOSTS as e,ICONS as f,RFP_DEFAULT_STATE as b,TRANSLATIONS as g,VALID_PROTOCOLS as h}from"./constants.js";let i=[];async function c(){let a=(await browser.storage.local.get([e]))[e];a instanceof Array?i=a:browser.storage.local.set({[e]:[]})}async function j(){let[a]=await browser.tabs.query({active:!0,currentWindow:!0});return a.url}function d(a,b){browser.browserAction.setIcon({path:a?f.RFP_ENABLED:f.RFP_DISABLED}),browser.browserAction.setTitle({title:a?browser.i18n.getMessage(g.TOOLTIP_DISABLE_RFP,b):browser.i18n.getMessage(g.TOOLTIP_ENABLE_RFP,b)}),browser.privacy.websites.resistFingerprinting.get({}).then(({value:b})=>{b!==a&&browser.privacy.websites.resistFingerprinting.set({value:a})})}async function k(a){let b=i.length?i:(await browser.storage.local.get([e]))[e];return!b.includes(a)}async function a(){let a=await j();if("string"==typeof a){let b=function(a){try{return new URL(a)}catch(b){throw browser.browserAction.setIcon({path:f.RFP_DEFAULT}),browser.browserAction.setTitle({title:browser.i18n.getMessage(g.ERROR_INVALID_URL)}),b}}(a);if(!h.includes(b.protocol)){browser.browserAction.setIcon({path:f.RFP_DEFAULT}),browser.browserAction.setTitle({title:browser.i18n.getMessage(g.TOOLTIP_RFP_UNAVAILABLE)});return}let{host:c}=b,e=await k(c);d(e,c)}}await c(),d(b),browser.browserAction.onClicked.addListener(async()=>{let c=await j();if("string"==typeof c){let f=new URL(c);if(!h.includes(f.protocol))return;let{host:b}=f,g=await k(b),a=(await browser.storage.local.get([e]))[e];g?a.push(b):a=a.filter(a=>a!==b),browser.storage.local.set({[e]:a}),i=a,d(!g,b)}}),browser.tabs.onUpdated.addListener(a),browser.tabs.onActivated.addListener(a)